\subsection{Queries}

Now that we have built and populated our database, it is time that we use it to retrieve useful information for various users. Therefore we need to create some queries that will perform this task.

\subsubsection{Query Descriptions}

What follows is a description of some queries that will need to be retrieved from the database.

\begin{enumerate}
	\item
	Perhaps the most frequent query that will be used is a search query. In essence, the query would be \emph{obtain all questions whose title or body contain the provided words}.

	\item
	Another query which will be often requested is one that retrieves questions to display on a user's home page. We can describe it as follows. \emph{Retrieve the most popular questions which relate to a topic which a certain user follows}.

	\item
	An alternative query to the previous one with a similar purpose can be to obtain new questions which have not yet been answered instead of popular ones. We can describe this one as follows. \emph{Retrieve the newest unanswered questions which relate to a topic which a certain user follows}.

	\item
	This query is one that will have to be performed every time a question is loaded. \emph{Find all answers which answer the question with a particular ID}.

	\item
	Similar to the previous one, whenever any post is loaded, we would need to query for all the comments on that post. \emph{Select all comments whose parent post has a certain ID}.

	\item
	A user may be interested in viewing all the answers that have been given to the questions they ask, together with any comments on any of their posts, in an `inbox' fashion. \emph{Obtain all answers to questions as well as all comments to posts which were posted by a certain user, sorted from newest to oldest}.

	\item
	Ask Us is interested in sending out a weekly newsletter containing the most popular questions with one of their answers each from the previous week. A query which would obtain these questions would look like this. \emph{Obtain a certain number of questions, as well as each of their highest voted answers, which were posted between two weeks ago and one week ago, and received the most votes within a week of their posting}.

	\item
	Ask Us would like to display on a user's profile page all the questions, answers, and comments which they posted. \emph{Retrieve all questions, answers, and comments whose author is a specific user, sorted by newest first}.

\end{enumerate}

\subsubsection{Writing the Queries in SQL}

Next we must convert these queries into SQL code. Wherever user input would have been appropriate, we used a literal instead. The results obtained are logged in CSV files in the directory \verb`/data/queries/`.

The first query searches for a certain search phrase which is provided by the user. Here it is in SQL. This query took 0.071 seconds to execute.

\VerbatimInput[label=\fbox{\color{Black}/sql/queries/search.sql}]{../sql/queries/search.sql}

The next queries retrieve information to display on a user's home page, sorted to show the most popular or the newest answers. They are displayed below in SQL. They took 0.015 seconds and 0.012 seconds to execute, respectively.

\VerbatimInput[label=\fbox{\color{Black}/sql/queries/home\_page\_popularity.sql}]{../sql/queries/home_page_popularity.sql}
\VerbatimInput[label=\fbox{\color{Black}/sql/queries/home\_page\_new.sql}]{../sql/queries/home_page_new.sql}

Next we have the query that retrieves all the answers to a question. This one took 0.015 seconds to retrieve the results.

\VerbatimInput[label=\fbox{\color{Black}/sql/queries/answers.sql}]{../sql/queries/answers.sql}

After that, we created the query that obtains the direct child comments of a particular post. This query took 0.01 seconds.

\VerbatimInput[label=\fbox{\color{Black}/sql/queries/comments.sql}]{../sql/queries/comments.sql}

The next query we have is the one that finds all answers for a particular user's questions. This one took 0.041 seconds.

\VerbatimInput[label=\fbox{\color{Black}/sql/queries/inbox.sql}]{../sql/queries/inbox.sql}

The query which retrieves content for the newsletter is written in SQL here. This query took 0.44 seconds to run. Since at the time which we ran the query there was no data with a timestamp within the past seven days, we ran the query to retrieve data from the past year only for this test.

\VerbatimInput[label=\fbox{\color{Black}/sql/queries/newsletter.sql}]{../sql/queries/newsletter.sql}

The last query we have is one that retrieves the content to display on a user's profile page. This query took 0.019 seconds.

\VerbatimInput[label=\fbox{\color{Black}/sql/queries/profile.sql}]{../sql/queries/profile.sql}